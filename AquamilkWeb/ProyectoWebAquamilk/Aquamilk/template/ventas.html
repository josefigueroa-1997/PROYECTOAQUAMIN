{% extends '_base.html' %}
{% load static %}
{% block title %}Ventas{% endblock %}
{% block css %}
<link href="{% static 'css/usuario.css'%}" rel="stylesheet" type="text/css">
<link href="{% static 'css/ventas.css'%}" rel="stylesheet" type="text/css">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}


{% block content %}

<div class="search-bar">
    <input type="text" id="searchinput" placeholder="Buscar venta...">
   
</div>
<button class="botonPersonalizados" id="botonPersonalizado">Agregar Venta</button>
<div class="container mx-auto mt-4">
    <div class="text-center"> <!-- Agrega la clase text-center aquí -->
        <h1 class="text-2xl font-bold">Ventas {% if tipoventa %}{{ tipoventa }}{% endif %}</h1>
    </div>
    <ul class="flex">
        <li class="mr-6">
            <a href="{% url 'ventas' %}" class="text-blue-500 hover:text-blue-800" data-tipoventa="Planta">Planta</a>
        </li>
        <li class="mr-6">
            <a href="{% url 'ventas' %}?tipoventa=Hogar" class="text-blue-500 hover:text-blue-800" data-tipoventa="Hogar">Hogar</a>
        </li>
    </ul>

</div>

<div class="overflow-y-auto">
    <div class="min-w-full">
    
<table id="tablaventas" class="min-w-full divide-y divide-gray-200">
    <thead class="sticky top-0 ">
        <tr class="bg-gray-50">
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Numero Venta</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">20 LTS</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">10 LTS</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detalle</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metodo Pago</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado Pago</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comuna</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Historial</th>
        </tr>
    </thead>
    {% if ventas %}    
    <tbody id="tablaVentas" class="bg-white divide-y divide-gray-200">
        {% for venta in ventas %}
        <tr>
            <td class="px-6 py-4 whitespace-nowrap">{{ venta.numeroVenta }}</td>
            <td class="px-6 py-4 whitespace-nowrap">{{ venta.fecha }}</td>
            <td class="px-6 py-4 whitespace-nowrap">{{ venta.nombreUsuario }}</td>
            <td class="px-6 py-4 whitespace-nowrap">{{ venta.veinteLTS }}</td>
            <td class="px-6 py-4 whitespace-nowrap">{{ venta.diezLTS }}</td>
            <td class="px-6 py-4 whitespace-nowrap">{{ venta.detalle }}</td>
            <td class="px-6 py-4 whitespace-nowrap">{{ venta.metodo_Pago }}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                {% if venta.estado_Pago == 'PAGADO' %}
                <input type="checkbox" class="form-checkbox h-6 w-6 text-green-500 border-gray-300 rounded focus:ring-green-500 {% if venta.estado_Pago == 'PAGADO' %} bg-green-500 {% endif %}" {% if venta.estado_Pago == 'PAGADO' %} checked {% endif %}>

                {% else %}
                <input type="checkbox" class="form-checkbox h-6 w-6 text-green-500 border-gray-300 rounded focus:ring-green-500 {% if venta.estado_Pago == 'PAGADO' %} bg-green-500 {% endif %}" {% if venta.estado_Pago == 'PAGADO' %} checked {% endif %}>

                {% endif %}
            </td>   
            <td class="px-6 py-4 whitespace-nowrap">{{ venta.comuna }}</td>
        <td class="px-6 py-4 whitespace-nowrap">{{ venta.total }}</td>
        
        <td class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded cursor-pointer ver-historial-btn" data-idusuario="{{ venta.idUsuario }}" data-fecha="{{ venta.fecha }}">
            Ver Historial
        </td>
        
        
        </tr>
        
        {% endfor %}
    </tbody>
    {% endif %}
</table>

</div>
</div>
<!-- Modal Agregar Usuario -->
<div id="modalventa" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white p-8 rounded-md max-w-screen-lg">
        <h2 class="text-lg font-semibold mb-4">Agregar Nueva Venta</h2>
        <form method="POST" id="formularioVenta">
          {% csrf_token %}
          <div class="flex flex-wrap -mx-3 mb-4">
            
            <div class="w-full md:w-1/3 px-3">
                <label for="usuario" class="block text-sm font-medium text-gray-700">Usuario:</label>
                <select id="usuario" name="usuario" class="mt-1 p-2 block w-full rounded-md border border-gray-300 focus:border-blue-500 " style="max-height: 200px; overflow-y: auto; width: 100%; height: 40px;">
                    <option value="" disabled>Selecciona un Usuario</option>
                </select>
            </div>
            <div class="w-full md:w-1/3 px-3">
                <label for="producto" class="block text-sm font-medium text-gray-700">Producto:</label>
                <select id="producto" name="producto" class="mt-1 p-2 block w-full rounded-md border border-gray-300 focus:border-blue-500 ">
                    <option value="">Selecciona un producto</option>
                </select>
            </div>
            <div class="w-full md:w-1/3 px-3">
                <label for="fecha" class="block text-sm font-medium text-gray-700">Fecha:</label>
                <input type="date" id="fecha" name="fecha" class="mt-1 p-2 block w-full rounded-md border border-gray-300 focus:border-blue-500">
            </div>
        </div>

        <div class="flex flex-wrap -mx-3 mb-4">
            <div class="w-full md:w-1/3 px-3 mb-4 md:mb-0">
                <label for="metododepago" class="block text-sm font-medium text-gray-700">Método de Pago:</label>
                <select id="metodo" name="metodo" class="mt-1 p-2 block w-full rounded-md border border-gray-300 focus:border-blue-500 " style="max-height: 200px; overflow-y: auto; width: 100%; height: 40px;">
                    <option value="" >Selecciona un Método de Pago</option>
                    <option value="EFECTIVO">Efectivo</option>
                    <option value="TARJETA">Tarjeta</option>
                    <option value="TRANSFERENCIA">Transferencia</option>
                </select>
            </div>
            
            <div class="w-full md:w-1/3 px-3 mb-4 md:mb-0">
                <label for="estadoPago" class="block text-sm font-medium text-gray-700">Estado de Pago:</label>
                <div class="flex items-center mt-2">
                    <input type="radio" id="pagado" name="estadoPago" value="PAGADO" class="mr-2">
                    <label for="pagado" class="mr-4">Pagado</label>

                    <input type="radio" id="noPagado" name="estadoPago" value="NO_PAGADO" class="mr-2">
                    <label for="noPagado">No Pagado</label>
                </div>
            </div>

            <div class="w-full md:w-1/3 px-3 mb-4 md:mb-0">
                <label for="cantidad" class="block text-sm font-medium text-gray-700">Cantidad:</label>
                <input type="number" id="cantidad" name="cantidad" class="mt-1 p-2 block w-full rounded-md border border-gray-300 focus:border-blue-500">
            </div>
        </div>

        <div class="flex flex-wrap -mx-3 mb-4">
            <div class="w-full md:w-1/2 px-3 mb-4 md:mb-0">
                <label for="Prioridad" class="block text-sm font-medium text-gray-700">Prioridad:</label>
                <select id="prioridad" name="prioridad" class="mt-1 p-2 block w-full rounded-md border border-gray-300 focus:border-blue-500 " style="max-height: 200px; overflow-y: auto; width: 100%; height: 40px;">
                    <option value="" >Selecciona una Prioridad</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                </select>
            </div>
            <div class="w-full md:w-1/2 px-3 mb-4 md:mb-0">
                <label for="Precio" class="block text-sm font-medium text-gray-700">Precio:</label>
                <input disabled type="text" id="precio" name="precio" class="mt-1 p-2 block w-full rounded-md border border-gray-300 focus:border-blue-500">
            </div>
        </div>
        <input  type="hidden" id="tipodeventa" name="tipodeventa" class="mt-1 p-2 block w-full rounded-md border border-gray-300 focus:border-blue-500">
        <div class="flex justify-end">
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md">Agendar</button>
            <button type="button" id="cerrarmodalventa" class="ml-2 bg-red-500 text-white px-4 py-2 rounded-md">Cancelar</button>
        </div>
    </form>
</div>

<!--MODAL HISTORIAL VENTAS CLIENTE-->
<div id="modalHistorialCliente" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white p-8 rounded-md max-w-screen-lg">
        <h2 class="text-lg font-semibold mb-4">Historial Ventas Usuario</h2>
        <div class="modal-content">
            <p>fsdogjmfdlkgfjglfkjgfdlgkj</p>
            <!--<div id="accordion" class="divide-y divide-gray-200"></div>-->
        </div>
        
            <button type="button" id="cerrarModalHistorialCliente" class="ml-2 bg-red-500 text-white px-4 py-2 rounded-md">Cancelar</button>
        
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    document.querySelectorAll('.ver-historial-btn').forEach(function(button) {
    button.addEventListener('click', function() {
        var idUsuario = this.getAttribute('data-idusuario');
        var fecha = this.getAttribute('data-fecha');
        window.location.href = '{% url "historial" %}?idusuario=' + idUsuario + '&fecha=' + encodeURIComponent(fecha);
    });
});
</script>
<script>
    document.getElementById('botonPersonalizado').addEventListener('click', function(event) {
        event.stopPropagation();
        // Oculta el modal de Historial Cliente si está abierto
        
        // Muestra el modal de Agendar Venta
        $('#modalventa').removeClass('hidden');
    });

    document.getElementById('cerrarmodalventa').addEventListener('click', function() {
        // Oculta el modal de Agendar Venta
        $('#modalventa').addClass('hidden');
    });
</script>
<script>
    // Agregar un evento de clic al botón de historial
    $('.btnhistorial').click(function() {
        // Muestra el modal de historial de ventas del cliente
        $('#modalHistorialCliente').removeClass('hidden');
        
    });

    // Agregar un evento de clic al botón de cancelar en el modal de historial de ventas del cliente
    $('#cerrarModalHistorialCliente').click(function() {
        // Oculta el modal de historial de ventas del cliente
        $('#modalHistorialCliente').addClass('hidden');
    });
</script>
<!--OBTENER USUARIOS-->
<script>
    var selectUsuarios = document.getElementById('usuario');
    var opcionesOriginales = [];
    function cargaropciones(){
        $.ajax({
            url: '{% url "recuperarusuarios" %}',
            type: 'GET',
            success: function(data) {
                // Limpiar el select
                selectUsuarios.innerHTML = '<option value="" disabled>Selecciona un Usuario</option>';
                opcionesOriginales = [];

                // Agregar las opciones recibidas del servidor
                data.usuarios.forEach(function(usuario) {
                    var opcion = new Option(usuario.nombre, usuario.id);
                    selectUsuarios.add(opcion);
                   
                    opcionesOriginales.push(opcion);
                });
                $('#usuario').select2();
            },
            error: function(xhr, status, error) {
                console.error('Error al obtener usuarios:', error);
            }
        });
    }
   

    cargaropciones();
    
   
  </script>
  <!--OBTENER PRODUCTOS-->
<script>
     
    // Función para cargar los productos en el select2
    function cargarProductosEnSelect2(productos) {
        var selectProducto = $('#producto');
        selectProducto.empty(); // Limpiar el select2
        
        // Agregar la opción por defecto
        selectProducto.append($('<option>').attr('value', '').text('Selecciona un producto'));
        
        // Agregar las opciones de productos
        productos.forEach(function(producto) {
            selectProducto.append($('<option>').attr('value', producto.id).text(producto.tipo_Producto + ' - Precio: ' + producto.precio));
        });
        
 
      
        
        // Llamar a la función para establecer el tipo de venta después de cargar los productos
        establecerTipoVenta();
    }
    
    // Función para establecer el tipo de venta según el producto seleccionado
    function establecerTipoVenta() {
        var selectProducto = document.getElementById('producto');
        var tipoVentaInput = document.getElementById('tipodeventa');

        // Verificar si selectProducto y tipoVentaInput son elementos válidos
        if (selectProducto && tipoVentaInput) {
            // Obtener el índice seleccionado del producto
            var selectedIndex = selectProducto.selectedIndex;

            // Verificar si se ha seleccionado un producto real (el índice es mayor que 0)
            if (selectedIndex > 0) {
                // Obtener el texto del producto seleccionado
                var productoSeleccionado = selectProducto.options[selectedIndex].text;

                // Depuración: Imprimir el valor del producto seleccionado en la consola
                console.log('Producto seleccionado:', productoSeleccionado);

                // Verificar si el producto contiene la palabra "Planta"
                if (productoSeleccionado.includes('Planta')) {
                    // Si el producto es de tipo "Planta", establecer el tipo de venta como "Planta"
                    tipoVentaInput.value = 'Planta';
                } else if (productoSeleccionado.includes('Hogar')) {
                    // Si el producto es de tipo "Hogar", establecer el tipo de venta como "Hogar"
                    tipoVentaInput.value = 'Hogar';
                } else {
                    // Si el producto no coincide con ninguno de los criterios anteriores, dejar el campo de tipo de venta vacío
                    tipoVentaInput.value = '';
                }

                // Depuración: Imprimir el valor del campo tipodeventa después de la asignación
                console.log('Tipo de venta:', tipoVentaInput.value);
            }
        }
        habilitarprioridad();
    }
    function habilitarprioridad() {
        var tipoventa = document.getElementById('tipodeventa');
        var prioridad = document.getElementById('prioridad');

        if (tipoventa.value.toLowerCase() === 'hogar') {
            prioridad.disabled = false;
        } else {
            prioridad.disabled = true;
            prioridad.selectedIndex = 0;
        }
    }

    // Llamar a la función para cargar los productos una vez que se haya cargado la página
    $(document).ready(function() {
        // Realizar una solicitud AJAX para recuperar los productos
        $.ajax({
            url: '{% url "recuperarproductos" %}',
            type: 'GET',
            success: function(data) {
                // Verificar si se recibieron los datos correctamente
                if (data.hasOwnProperty('productos')) {
                    // Llamar a la función para cargar los productos en el select2
                    cargarProductosEnSelect2(data.productos);
                } else {
                    console.error('Los datos recibidos no contienen la lista de productos.');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error al recuperar los productos:', error);
            }
        });
    });

    // Agregar un event listener para el cambio en el campo de selección de productos
    $(document).on('change', '#producto', function() {
        // Llamar a la función para establecer el tipo de venta cada vez que se cambie la selección de productos
        establecerTipoVenta();
    });
    document.getElementById('tipodeventa').addEventListener('input', function() {
        habilitarprioridad();
    });
</script>
</script>
<!--BUSCARDOR DE DATOS EN LA TABLA-->
<script>
    document.getElementById('searchinput').addEventListener('input',function(){

var searchtext = this.value.toLowerCase();
var rows = document.getElementById('tablaVentas').getElementsByTagName('tr');

for(var i= 0;i< rows.length;i++){
    var cells = rows[i].getElementsByTagName('td');
    var found = false;

    for(var j = 0;j<cells.length;j++){
        var cellstext = cells[j].textContent.toLocaleLowerCase();
        if(cellstext.indexOf(searchtext)>-1){
            found = true;
            break;
        }
    }
    if(found){
        rows[i].style.display = '';
    }
    else{
        rows[i].style.display= 'none';
    }
}
});

</script>

<!--MOSTRAR HISTORIAL USUARIO-->
<script>
    /*
    $(document).ready(function(){
        var colors = ['#14B1EC', '#ffffff', '#2ecc71']; 
        var colorIndex = 0;
        var colorCount = colors.length;
        var totalCantidadElement = $('<div>').attr('id', 'total-cantidad');
        
        $('.ver-historial').click(function() {
            console.log("Clic en el botón 'Ver Historial' detectado.");
            var idUsuario = $(this).data('id');
            var fechaString = $(this).data('fecha');
  
            var partesFecha = fechaString.split('/');
            var dia = partesFecha[0];
            var mes = partesFecha[1];
            var año = partesFecha[2];

      
            var fechaFormateada = año + '-' + mes + '-' + dia;
            
        
            var fecha = new Date(fechaFormateada);

            $.ajax({
                url: "{% url 'historialventas' %}",
                method: 'GET',
                data: {
                    'idusuario': idUsuario,
                    'fecha': fecha.toISOString()
                },
                success: function(data){
                    
                    $('#accordion').empty();
                    var  cantidadbidones = 0;
                    var totalprecio = 0;
        
                    $.each(data, function(index, item){
                        var collapseId = 'collapse-' + index;
                        var accordionItem = $('<div class="accordion-item w-full">'); // Agregar la clase w-full para ocupar todo el ancho disponible
                        var accordionHeader = $('<div class="accordion-header collapsed">').append($('<button class="accordion-button" type="button">').text('ID Venta: ' + item.idventa + ' - Tipo Producto: ' + item.tipO_PRODUCTO + '- Cantidad: '+item.cantidad+ ' - Total: ' + item.cantidad * item.preciounitario));
                        var accordionCollapse = $('<div id="' + collapseId + '" class="accordion-content" style="display: none;">').text('Detalle: ' + item.detalle + ' - Estado de Pago: ' + item.estadO_PAGO + ' - Método de Pago: ' + item.metodO_PAGO );
                        cantidadbidones = cantidadbidones + item.cantidad;
                        
                
                        accordionItem.append(accordionHeader, accordionCollapse);
                        $('#accordion').append(accordionItem);


                        accordionItem.css('background-color', colors[colorIndex]);

                        colorIndex = (colorIndex + 1) % colorCount;

    
                        accordionHeader.click(function(){
                            $(this).toggleClass('active');
                            $(this).toggleClass('collapsed'); 
                            $(this).next('.accordion-content').slideToggle();
                        });
                    });

           
                    $('#modalHistorialCliente').removeClass('hidden');
                    totalCantidadElement.empty();
              
                    totalCantidadElement.text('Cantidad Total: ' + cantidadbidones);
                },
                error: function(xhr, status, error){
                    console.error('Error al obtener el historial de ventas del usuario:', error);
                }
            });
        });

        $('#cerrarModalHistorialCliente').click(function(){
            $('#modalHistorialCliente').addClass('hidden');
        });
        
        $('#modalHistorialCliente .modal-content').append(totalCantidadElement);
    });*/
</script>

<!--MARCAR FILAS CON FECHA ACTUAL-->
<script>
$(document).ready(function(){
    // Formatear la fecha actual
    var currentDate = new Date().toLocaleDateString('es-ES');

    $('#tablaVentas tr').each(function(){
        // Obtener la fecha de la fila y formatearla
        var rowDateStr = $(this).find('td:eq(1)').text().trim();
        var rowDateParts = rowDateStr.split('/');
        var formattedRowDate = rowDateParts[1] + '/' + rowDateParts[0] + '/' + rowDateParts[2];
        var rowDate = new Date(formattedRowDate);

        if (!isNaN(rowDate.getTime())) {
            // Si la fecha es válida, continuamos con la comparación
            var rowFormattedDate = rowDate.toLocaleDateString('es-ES');
            // Comparar las fechas
            if (rowFormattedDate === currentDate) {
                $(this).addClass('current-date-row');
            } else {
                console.log("Fecha de la fila no coincide con la fecha actual.");
            }
        } else {
            console.log("Fecha de la fila no válida:", rowDateStr);
        }
    });
});
</script>



{% endblock %}